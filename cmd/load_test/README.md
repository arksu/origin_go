# Load Test Runner

Нагрузочный тест для проверки производительности игрового сервера Origin. Симулирует множество виртуальных клиентов (VU) с различными сценариями поведения.

## Возможности

- **Управление аккаунтами**: Автоматическое создание/использование тестовых аккаунтов
- **Два сценария**: `login-only` и `login-move`
- **Плавный разгон**: Постепенное увеличение числа клиентов
- **Сбор метрик**: Измерение задержек (p50/p95/p99) и счетчиков
- **Воспроизводимость**: Детерминированная генерация случайных данных через seed

## Установка и запуск

### Сборка
```bash
make load-test-build
```

### Запуск
```bash
./load_test [параметры]
```

Или через Make:
```bash
make load-test
```

## Параметры командной строки

### База данных
- `--db_host` - хост PostgreSQL (default: localhost)
- `--db_user` - пользователь БД (default: origin)
- `--db_password` - пароль БД (default: origin)
- `--db_name` - имя БД (default: origin)
- `--db_schema` - схема БД (default: origin)

### Игровой сервер
- `--server_host` - хост игрового сервера (default: localhost)
- `--server_port` - порт сервера (default: 8080)

### Нагрузка
- `--clients` - число одновременных клиентов (default: 10)
- `--ramp-up` - скорость разгона, клиентов/сек (default: 1)
- `--duration` - длительность теста (default: 60s)
- `--scenario` - сценарий: `login-only` или `login-move` (default: login-move)

### Движение
- `--move-radius` - радиус движения в мировых единицах (default: 100)
- `--period` - период между командами движения (default: 1s)

### Прочее
- `--seed` - seed для генератора случайных чисел (default: 0 = текущее время)

## Сценарии

### login-only
1. Авторизация через REST API
2. Создание персонажа (если нужно)
3. Получение токена входа в мир
4. Подключение по WebSocket
5. Аутентификация в игровом мире
6. Ожидание `S2C_PlayerEnterWorld`
7. Отключение

### login-move
Все этапы `login-only` плюс:
8. Цикл движения: каждые `period` секунд отправка `C2S_PlayerAction.MoveTo`
9. Обработка `S2C_ObjectMove` для обновления позиции

## Примеры использования

### Базовый тест
```bash
./load_test --clients=10 --duration=30s
```

### Тест с разгоном
```bash
./load_test --clients=100 --ramp-up=5 --duration=120s
```

### Только логины
```bash
./load_test --clients=50 --scenario=login-only --duration=60s
```

### Тест движения
```bash
./load_test --clients=20 --move-radius=200 --period=500ms --duration=90s

/load_test -clients=6 -ramp-up=5 -duration=120s -scenario=login-move
```

### Воспроизводимый тест
```bash
./load_test --clients=30 --seed=12345 --duration=60s
```

## Метрики

По завершении теста выводится сводка:

```
=== Load Test Summary ===
Duration total: 1m0.123s
Login attempts: 30 successes: 30 failures: 0 p50: 45ms p95: 78ms p99: 120ms
EnterWorld attempts: 30 successes: 30 failures: 0 p50: 89ms p95: 145ms p99: 200ms
Movement moves_sent: 600 moves_received: 598
Packets sent: 630 received: 1250
Errors total: 0
```

### Описание метрик

- **Login**: Авторизация через REST API
- **EnterWorld**: Вход в игровой мир
- **Movement**: Отправленные/полученные команды движения
- **Packets**: Общее количество пакетов
- **Errors**: Число ошибок во время выполнения

## Архитектура

### Virtual Client (VU)
Каждый виртуальный клиент проходит стадии:
1. **AcquireAccount** - получение аккаунта из пула
2. **Auth/Login** - REST API логин
3. **CharacterList** - получение списка персонажей
4. **CreateCharacter** - создание при необходимости
5. **Connect** - WebSocket соединение
6. **EnterWorld** - вход в игровой мир
7. **MoveLoop** - цикл движения (опционально)

### Account Pool
Пул аккаунтов с блокировкой для предотвращения конфликтов:
- Автоматически создает аккаунты при нехватке
- Использует случайные логины (6 символов, префикс "lt_")
- Пароль всегда "123"
- Отслеживает занятые аккаунты в памяти

### Metrics
Сбор статистики:
- Latency: p50, p95, p99 для логинов и входа в мир
- Counters: попытки, успехи, ошибки
- Real-time: пакеты, движения

## Требования

- PostgreSQL с базой данных Origin
- Запущенный игровой сервер
- Go 1.19+

## Траблшутинг

### Ошибка подключения к БД
Проверьте параметры `--db_*` и доступность PostgreSQL.

### Ошибка подключения к серверу
Убедитесь что сервер запущен и доступен по `--server_host:--server_port`.

### Медленные логины
Проверьте производительность REST API endpoints и БД.

### Клиенты не входят в мир
Проверьте логи сервера на предмет ошибок аутентификации.

### Высокий packet loss
Проверьте сетевые настройки и производительность WebSocket сервера.

## Разработка

### Структура файлов
```
cmd/load_test/
├── main.go           # CLI и Runner
├── account_pool.go   # Управление аккаунтами
├── virtual_client.go # Виртуальный клиент
├── metrics.go        # Сбор метрик
└── README.md         # Этот файл
```

### Добавление новых сценариев
1. Добавьте новый тип в `parseFlags()`
2. Реализуйте логику в `VirtualClient.Run()`
3. Обновите документацию

### Добавление метрик
1. Добавьте счетчики/таймеры в `Metrics`
2. Вызывайте методы записи в нужных местах
3. Обновите `PrintSummary()`
