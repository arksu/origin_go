# ADR 0002: Sound Events через `S2C_Sound` + `VisibilityState`

- Status: Proposed
- Date: 2026-02-13
- Owners: Game Server / Game Client

## 1. Context

Звук сейчас отправляется как часть циклических пакетов действий (`S2C_CyclicActionProgress`, `S2C_CyclicActionFinished`), что:
1. Жёстко связывает звук с одной механикой.
2. Усложняет расширения на другие источники звука.
3. Не даёт общей модели пространственного звука.

Нужно перейти к общей event-модели звуковых источников в мире:
1. отдельный звуковой пакет,
2. координаты источника,
3. радиус слышимости,
4. рассылка по видимости источника через `VisibilityState`.

## 2. Decision

1. Вводится новый пакет `S2C_Sound`.
2. Поле `sound_key` удаляется из:
   - `S2C_CyclicActionProgress`,
   - `S2C_CyclicActionFinished`.
3. Для рубки деревьев:
   - конец цикла → отправляется `chop`,
   - завершение действия → отправляется `tree_fall`.
4. Координаты источника звука рубки всегда берутся из `Transform` дерева.
5. Радиус слышимости задаётся жёсткой серверной константой `DefaultMaxHearDistance = 800`.
6. Сервер отправляет звук всем игрокам, которые видят объект-источник, по `VisibilityState`.
7. На клиенте громкость рассчитывается линейно от расстояния, расчёт выделяется в отдельную функцию.

## 3. Protocol Contract

`S2C_Sound`:
1. `sound_key` — ключ звука.
2. `x`, `y` — координаты источника в world coords.
3. `max_hear_distance` — максимальная дистанция слышимости (в текущей итерации всегда `800` от сервера).

## 4. Server Architecture

Принято решение выделить отдельный звуковой слой в сервере:

1. Новый отдельный модуль/сервис для sound events.
2. Gameplay-код (tree behavior) только сигнализирует "проиграть звук у источника", без direct network send.
3. Sound service отвечает за:
   - формирование `S2C_Sound`,
   - получение наблюдателей источника из `VisibilityState`,
   - отправку пакетов получателям.

Это решение вводится сразу как архитектурная база для будущих расширений.

## 5. Client Audio Decision

1. Клиент использует 2D UI-style звук (без панорамы/3D spatialization).
2. Логика громкости:
   - если `distance > max_hear_distance` → не играть,
   - иначе `attenuation = max(0, 1 - distance/max_hear_distance)`.
3. Формула вынесена в отдельную функцию для последующей замены (например, на экспоненту/кастомную кривую).

## 6. Consequences

Плюсы:
1. Звуковая система отделена от конкретных gameplay-пакетов.
2. Упрощается добавление звука в другие механики (крафт, удары, ambient).
3. Простая и прозрачная модель слышимости: "кто видит источник, тот получает событие".

Минусы:
1. Нужен новый слой на сервере (больше сущностей/кода).
2. Дополнительная нагрузка на рассылку при массовых событиях (требует дальнейших лимитов/дедупа, если понадобится).

## 7. Rejected Alternatives

1. Оставить `sound_key` в cyclic пакетах:
   - отклонено из-за сильной связности и плохой расширяемости.
2. Отправлять звук только актору:
   - отклонено, нарушает мультиплеерное восприятие мира.
3. Считать затухание на сервере:
   - отклонено на текущем этапе; клиент уже знает позицию игрока и может дешевле применять локальную кривую.

## 8. Implementation Notes

1. В object defs для tree остаются:
   - `action_sound` (конец цикла),
   - `finish_sound` (конец действия).
2. `max_hear_distance` не конфигурируется per-sound/per-object в этой итерации.
3. В будущем допускается расширение `S2C_Sound` доп.полями (категория, приоритет, затухание-тип и т.д.) без изменения базовой архитектуры.
