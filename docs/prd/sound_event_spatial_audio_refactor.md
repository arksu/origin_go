# PRD: Sound Event Refactor (`S2C_Sound`) + Spatial Attenuation

## 1. Problem Statement

Текущая модель передачи звуков завязана на `S2C_CyclicActionProgress`/`S2C_CyclicActionFinished` через `sound_key`.
Это создаёт жёсткую привязку звука к конкретной механике (циклические действия), усложняет расширение и не поддерживает общую модель источника звука в мире.

Нужна единая серверная модель звуковых событий:
1. Отдельный пакет звука.
2. Явная позиция источника.
3. Явный радиус слышимости.
4. Клиентское затухание по расстоянию.
5. Рассылка всем наблюдателям источника через `VisibilityState`.

## 2. Goals

1. Ввести отдельный пакет `S2C_Sound`.
2. Удалить `sound_key` из `S2C_CyclicActionProgress` и `S2C_CyclicActionFinished`.
3. Для рубки деревьев отправлять звуки по текущей логике триггеров:
   - `chop` в конце каждого цикла,
   - `tree_fall` в конце действия.
4. Отправлять звук не только актору, а всем игрокам, видящим объект-источник.
5. На клиенте применять линейное затухание громкости по расстоянию до источника.

## 3. Non-Goals

1. 3D-панорамирование (left/right pan, HRTF и т.д.).
2. UI-настройки звука (слайдеры/переключатели в интерфейсе).
3. Пер-звук настройка `max_hear_distance` в object defs.
4. Рефактор всех текущих и будущих механик звука (кроме рубки в этой итерации).

## 4. Product Scope

## 4.1 Protocol

Добавляется новый пакет:

- `S2C_Sound`
  - `sound_key: string`
  - `x: float64`
  - `y: float64`
  - `max_hear_distance: float64`

Из пакетов удаляется поле `sound_key`:
- `S2C_CyclicActionProgress`
- `S2C_CyclicActionFinished`

## 4.2 Server Rules

1. Источник координат для звука рубки: всегда `Transform` дерева.
2. Радиус слышимости: жёсткая серверная константа `800`.
3. Получатели: все игроки, которые видят объект-источник, по `VisibilityState`.
4. Триггеры отправки:
   - конец цикла рубки (`chop`),
   - успешное завершение рубки (`tree_fall`).

## 4.3 Client Rules

1. При получении `S2C_Sound` клиент вычисляет расстояние `d` от позиции игрока до `(x, y)`.
2. Если `d > max_hear_distance` — звук не проигрывается.
3. Иначе применяется линейный множитель:
   - `attenuation = max(0, 1 - d/max_hear_distance)`.
4. Формула выносится в отдельную функцию (для будущей замены кривой затухания).
5. Финальная громкость:
   - `finalVolume = soundDefVolume * audioSettingsVolume * attenuation`.

## 5. Server Architecture Requirement (New Sound Section)

На сервере вводится отдельный архитектурный раздел/модуль под звуки (база для расширений):

1. Отдельный компонент уровня `internal/game` (например, `sound_service.go` или `sound/` подпакет).
2. Единая точка отправки sound-событий.
3. Изоляция логики:
   - формирование payload,
   - определение наблюдателей через `VisibilityState`,
   - отправка `ServerMessage`.
4. Gameplay behaviors (tree и др.) не работают напрямую с low-level отправкой; они вызывают sound API.

Расширения, под которые закладывается архитектура:
1. Глобальные ambient sounds.
2. Разные правила слышимости (фракции/комнаты/зоны).
3. Ограничения частоты/дедупликация.
4. Варианты кривых затухания.

## 6. Object Def Contract

Для `tree` behavior сохраняются:
1. `action_sound` — звук конца цикла (`chop`).
2. `finish_sound` — звук конца действия (`tree_fall`).

## 7. Constants

Сервер:
1. `DefaultMaxHearDistance = 800` (жёсткая константа).

Клиент:
1. Использует `max_hear_distance` из пакета.
2. Не вводит локальных дефолтов для этого поля в рамках итерации.

## 8. Acceptance Criteria

1. В протоколе есть `S2C_Sound`, в cyclic пакетах нет `sound_key`.
2. В конце каждого цикла рубки всем наблюдателям дерева приходит `S2C_Sound(sound_key=chop, x,y,max_hear_distance=800)`.
3. В конце успешной рубки всем наблюдателям дерева приходит `S2C_Sound(sound_key=tree_fall, x,y,max_hear_distance=800)`.
4. Координаты `S2C_Sound` всегда равны координатам `Transform` дерева на момент отправки.
5. Клиент корректно применяет линейное затухание и не воспроизводит звук вне радиуса.
6. Расчёт затухания выделен в отдельную функцию.
7. Серверная звуковая логика выделена в отдельный архитектурный блок (не размазана по behavior-ам и transport-коду).

## 9. Risks

1. Неправильный источник координат приведёт к неверной громкости.
2. Ошибка в выборе наблюдателей через `VisibilityState` приведёт к пропуску/лишней рассылке звуков.
3. Низкий `max_hear_distance` может визуально "ломать" ощущение событий на границе AOI.

## 10. Validation

1. Unit (server): формирование `S2C_Sound` payload.
2. Unit (server): выбор получателей из `VisibilityState`.
3. Unit (client): формула линейного затухания.
4. Integration: мультиплеерная рубка, звуки приходят всем видящим дерево игрокам.
5. Regression: cyclic packets продолжают работать без `sound_key`.
